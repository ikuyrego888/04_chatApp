<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>Family-Chat</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- <div>
        <div>
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š<input id="emailAddress" type="email" required/>
        </div>
        <div>
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼š<input id="password" type="password" required/>
        </div>
        <button id="login">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="register">æ–°è¦ç™»éŒ²</button>
    </div> -->

    <div class="container">
        <div id="chatHeader">Family-Chat</div>
        <div class="chatBox">
            <div class="chatArea">
                <div id="output"></div>
            </div>
        </div>
    </div>
    <footer>
        <div id="unameText">
            <div>
                <input type="text" id="uname">
            </div>
            <div class="messageArea">
                <textarea name="" id="text"></textarea>
                <dig id="send"><img src="imgs/send.png" alt="" id="sendIcon"></dig>
            </div>
        </div>
    </footer>
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->


    <!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- JQuery -->


    <!--** ä»¥ä¸‹Firebase **-->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved }
            from "https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database.js";
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆFirebase Authenticationï¼‰
        // import { getAuth, createUserWithEmailAndPassword }
        //     from "firebase/suth";
        // import { getAuth, signInWithEmailAndPassword }
        //     from "https://www.gstatic.com/firebasejs/ui/10.7.1/firebase-ui-auth.js";
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLaMK-GlFo7KMSWOnY5YPpHftOAaPaHtQ",
            authDomain: "fir-test-9845e.firebaseapp.com",
            projectId: "fir-test-9845e",
            storageBucket: "fir-test-9845e.appspot.com",
            messagingSenderId: "648307675578",
            appId: "1:648307675578:web:770ad2e1f5ff0ab10f8d83"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‚ç…§ã‚’ä½œæˆ
        const db = getDatabase(app);
        const dbRef = ref( db , "chat" );
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼(æœ¬äºº)è¨­å®š
        let USER = "YUKI"

        // $("#register").on("click",function(){
        let email = $("#emailAddress").val();
        let password = $("#password").val();
        // let auth = getAuth();
        // let userCredential = await createUserWithEmailAndPassword(auth, email ,password)
        
        // const auth = getAuth();
        // createUserWithEmailAndPassword(auth, email, password).then((userCredential) => {
        //     const user = userCredential.user;
        // })
        // .catch((error) => {
        //     const errorCode = error.code;
        //     const errorMessage = error.message;
        // });

        // console.log(email);
        // console.log(password);
            
            // console.log(auth);
            // firebase.auth().createUserWithEmailAndPassword(email,password).catch(function(error){
            //     let errorCode = error.code;
            //     if (errorCode == "auth/invalid-email"){
            //         aleat("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
            //     }
            // }) .then(function(user){
            //     console.log(user);
                
            // });
        // });

        $("#send").on("click",function() {
            // textãŒç©ºã®å ´åˆã¯å‡¦ç†ã‚’ã‚„ã‚ã‚‹
            // .trim()ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§è¦‹ãˆãªã„ç©ºç™½ã‚’å‰Šé™¤ã—ã€æ”¹è¡Œã•ã‚Œã¦ã„ã¦ã‚‚textãŒç©ºã§ã‚ã‚Œã°é€ä¿¡ä¸å¯ã«ãªã‚‹
            let textCheck = $("#text").val().trim()
            console.log(textCheck);
            if ( textCheck == ""){
                return;
            }
            // unameã«ã‚ˆã£ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰ãˆã‚‹ï¼ˆæœ¬æ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¤å®šã‹ã€‚PHPï¼ŸğŸ’¡ï¼‰
            let userIcon = "";
            if ( $("#uname").val() == "æµå­" ){
                userIcon = `<img src = "imgs/iconBearV2.png" class="userIcon">`
                console.log(userIcon);
            } else if ( $("#uname").val() !== "æµå­" ){
                userIcon = `<img src = "imgs/iconV2.png" class="userIcon">`
                console.log(userIcon);
            }
            // é€ä¿¡æ™‚é–“ã®ãƒ­ã‚°ã‚’å–ã‚‹
            let now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth() + 1 ;
            let date = now.getDate();
            // æ›œæ—¥ã‚’é…åˆ—ä½¿ã£ã¦å–å¾—ã™ã‚‹
            let dayOfWeek = now.getDay();
            let dayOfWeekArry = ["(æ—¥)","(æœˆ)","(ç«)","(æ°´)","(æœ¨)","(é‡‘)","(åœŸ)"][dayOfWeek];
            let hours = now.getHours();
            let minutes = now.getMinutes();
            // minutesãŒä¸€æ¡ã®å ´åˆã€é ­ã«"0"ã‚’ä»˜ã‘ã‚‹
            minutes = String(minutes).padStart(2,"0");
            console.log(minutes);
            let nowCV = year + "/" + month + "/" + date + dayOfWeekArry + " " + hours + ":" + minutes;
            console.log(nowCV);
            const msg = {
                nowCV,
                userIcon,
                uname: $("#uname").val(),
                text: $("#text").val(),
            };
            // console.log(msg);
            const newPostRef = push(dbRef);
            set(newPostRef, msg);
            // ä»¥ä¸‹ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãŸã¨ãã«chatAreaã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸‹éƒ¨ã«ã™ã‚‹
            $(".chatArea").scrollTop($(".chatArea")[0].scrollHeight);
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãŸã‚‰textã‚’ç©ºã«ã™ã‚‹
            $("#text").val("");
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã—ãŸå¾Œã¯textã‚’Focusã™ã‚‹ã€‚
            $("#text").focus();
        })
    
    let iconBear = `<img src = imgs/iconBearV2.png class="userIcon">`
    
    // dbRefï¼ˆï¼"chat"ï¼‰ã«å…¥ã£ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®id(value)ã‚’ã‚­ãƒ¼ã«æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã‚‹
    onChildAdded(dbRef, function (data) {
        console.log(data);
        console.log(data.val());
        const msg = data.val(); //val()ã«ã‚ˆã‚Škeyã®ä¸­èº«ã®ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Šå‡ºã›ã‚‹ã€‚
        const key = data.key;
        console.log(key);
        if( msg.uname == USER ) {
            let h = `<div id="${key}" class="message00">`
            h += `<p id="dataUname00">`
            h += msg.uname;
            h += `</p><p id="dataTextNowCV00"><span id="dataIcon">`
            // h += msg.userIcon;
            h += `</span><span id="dataNowCV00">`
            h += msg.nowCV
            h += `</span><span id="dataText00">`
            h += msg.text
            h += `</span></p></div>`
            $("#output").append(h); // #output ã®æœ€å¾Œã«è¿½åŠ 
            // ä»¥ä¸‹ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã¨ãã«chatAreaã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸‹éƒ¨ã«ã™ã‚‹
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å·®ã—è¾¼ã‚“ã ã“ã¨ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒãšã‚Œã¦ã—ã¾ã†ğŸ’¡
            $(".chatArea").scrollTop($(".chatArea")[0].scrollHeight)
        } else if ( msg.uname !== USER ) {
            let h = `<div id="${key}" class="message">`
            h += `<p id="dataUname">`
            h += msg.uname;
            h += `</p><p id="dataTextNowCV"><span id="dataIcon">`
            h += msg.userIcon;
            h += `</span><span id="dataText">`
            h += msg.text
            h += `</span><span id="dataNowCV">`
            h += msg.nowCV
            h += `</span></p></div>`
            $("#output").append(h); // #output ã®æœ€å¾Œã«è¿½åŠ 
            // ä»¥ä¸‹ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã¨ãã«chatAreaã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸‹éƒ¨ã«ã™ã‚‹
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å·®ã—è¾¼ã‚“ã ã“ã¨ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒãšã‚Œã¦ã—ã¾ã†ğŸ’¡
            $(".chatArea").scrollTop($(".chatArea")[0].scrollHeight)
        }
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰å‰Šé™¤ã™ã‚‹
    $("#output").on("click", ".message" ,function(){
        // alert("ã‚¯ãƒªãƒƒã‚¯ã§ããŸã­");
        const clickMsg = $(this).attr("id");
        console.log(clickMsg);
        const chatRef = ref (db, "chat/" + clickMsg );
        remove(chatRef);
        $("#removeMsg").remove();
    });
    $("#output").on("click", ".message00" ,function(){
        // alert("ã‚¯ãƒªãƒƒã‚¯ã§ããŸã­");
        const clickMsg = $(this).attr("id");
        console.log(clickMsg);
        const chatRef = ref (db, "chat/" + clickMsg );
        remove(chatRef);
        $("#removeMsg").remove();
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰Firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã™ã‚‹
    onChildRemoved(dbRef, function(data) {
        console.log(data.val());
        const removeMsg = data.key;
        console.log(removeMsg)
        $("#"+ removeMsg).remove();
    })

    // Enterã‚­ãƒ¼(which===13)ã‚’æŠ¼ã™ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã§ãã‚‹
    // keyupã ã¨IMEç¢ºå®šæ™‚ã®Enterã§é€ä¿¡ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€keydownã¨ã™ã‚‹
    $("#text").on("keydown",function(event){
        // && !e.shihtKeyã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ Shiftã‚­ãƒ¼ï¼‹Enterã‚­ãƒ¼ ã®å ´åˆã¯æ”¹è¡Œ
        if (event.which === 13 && !event.shiftKey){
            $("#send").click()
        }
    })

    // textãŒç©ºã®å ´åˆã¯Enterã‚­ãƒ¼æŠ¼ã—ã¦ã‚‚æ”¹è¡Œã§ããªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
    // ä½†ã—ã€Shiftã‚­ãƒ¼ï¼‹Enterã‚­ãƒ¼ ã‚’æŠ¼ã›ã°æ”¹è¡Œã¯ã§ãã‚‹ã€‚
    $("#text").on("keydown",function(event){
        if ($("#text").val()=="" && event.which === 13 && !event.shiftKey){    
            event.preventDefault();
        }
    })


    </script>

</body>

</html>